#!/bin/bash

if [ -z "$1" ]; then
    echo "Usage: $0 <session name: sis | sdapi>"
    exit 1
fi

SESSION_NAME=$(echo "$1" | tr '[:upper:]' '[:lower:]')
VAR_NAME="REPO_$(echo "$SESSION_NAME" | tr '[:lower:]' '[:upper:]')"
REPO_PATH="${!VAR_NAME}"

if [ -z "$NOTES" ]; then
    echo "Error: \$NOTES is not set in your environment"
    exit 1
fi

if [ -z "$REPO_PATH" ]; then
    echo "Error: variable \$$VAR_NAME is not defined in your environment"
    exit 1
fi

if [ ! -d "$REPO_PATH" ]; then
    echo "Error: path $REPO_PATH does not exist"
    exit 1
fi

tmux has-session -t "$SESSION_NAME" 2>/dev/null
if [ $? != 0 ]; then
    echo "üü¢ Creating new tmux session: $SESSION_NAME"
    tmux new-session -d -s "$SESSION_NAME" -n notes -c "$NOTES"
    echo "üéØ Starting nvim in window 1 (notes)"
    tmux send-keys -t "$SESSION_NAME":1 'nvim .' C-m

    echo "‚ûï Creating window 2 (nvim)"
    tmux new-window -t "$SESSION_NAME":2 -n nvim -c "$REPO_PATH"
    tmux send-keys -t "$SESSION_NAME":2 'nvim .' C-m

    echo "‚ûï Creating window 3 (shell)"
    tmux new-window -t "$SESSION_NAME":3 -n shell -c "$REPO_PATH"

    echo "üéØ Selecting window 2 as focused window"
    tmux select-window -t "$SESSION_NAME":2
else
    echo "‚ÑπÔ∏è  Session '$SESSION_NAME' already exists ‚Äì skipping setup"
fi

echo "üîó Attaching to session $SESSION_NAME"
tmux attach-session -t "$SESSION_NAME"

tmux select-window -t "$SESSION_NAME":2
